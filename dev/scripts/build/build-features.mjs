#!/usr/bin/env bun
/**
 * build-features.mjs
 *
 * Auto-generates dev/src/features/index.ts by scanning the features directory.
 * This eliminates the need to manually import features in gamemode scripts.
 *
 * Usage: bun scripts/build-features.mjs
 *
 * Algorithm:
 * 1. Scan dev/src/features/ for directories containing index.ts
 * 2. Convert folder names (kebab-case) to camelCase variable names
 * 3. Generate import statements for each feature's create function
 * 4. Export an array of feature metadata (name, create function)
 * 5. Generate a type union of all feature types
 */

import fs from "fs";
import path from "path";
import { fileURLToPath } from "url";

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Configuration
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const FEATURES_DIR = path.join(__dirname, "../../src/features");
const OUTPUT_FILE = path.join(FEATURES_DIR, "index.ts");

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Helper Functions
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

/**
 * Convert kebab-case to camelCase
 * Example: "example-feature" ‚Üí "exampleFeature"
 */
function kebabToCamel(str) {
  return str.replace(/-./g, (match) => match[1].toUpperCase());
}

/**
 * Convert kebab-case to PascalCase
 * Example: "example-feature" ‚Üí "ExampleFeature"
 */
function kebabToPascal(str) {
  const camel = kebabToCamel(str);
  return camel.charAt(0).toUpperCase() + camel.slice(1);
}

/**
 * Check if a directory contains an index.ts file
 */
function hasIndexFile(dirPath) {
  const indexPath = path.join(dirPath, "index.ts");
  return fs.existsSync(indexPath);
}

/**
 * Discover all feature directories
 */
function discoverFeatures() {
  if (!fs.existsSync(FEATURES_DIR)) {
    console.error(`‚ùå Features directory not found: ${FEATURES_DIR}`);
    process.exit(1);
  }

  const entries = fs.readdirSync(FEATURES_DIR, { withFileTypes: true });

  const features = entries
    .filter((dirent) => dirent.isDirectory())
    .map((dirent) => dirent.name)
    .filter((name) => {
      const dirPath = path.join(FEATURES_DIR, name);
      return hasIndexFile(dirPath);
    })
    .sort(); // Alphabetical order for consistency

  return features;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Code Generation
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

/**
 * Generate the features index.ts file
 */
function generateFeaturesIndex(featureNames) {
  if (featureNames.length === 0) {
    console.warn("‚ö†Ô∏è  No features found in features directory");
    return `// No features found\nexport const features = [];\n`;
  }

  let code = "";

  // Header comment
  code += `/**\n`;
  code += ` * THIS FILE IS AUTO-GENERATED BY build-features.mjs\n`;
  code += ` * DO NOT EDIT MANUALLY - Your changes will be overwritten\n`;
  code += ` *\n`;
  code += ` * To add a new feature:\n`;
  code += ` * 1. Create a new directory in dev/src/features/\n`;
  code += ` * 2. Add an index.ts file with a create function and type export\n`;
  code += ` * 3. Run: bun run build\n`;
  code += ` *\n`;
  code += ` * Generated on: ${new Date().toISOString()}\n`;
  code += ` */\n\n`;

  // Import statements
  // Import everything from each feature module and let TypeScript infer types
  featureNames.forEach((folderName) => {
    code += `import * as ${kebabToCamel(folderName)}Module from "./${folderName}";\n`;
  });

  code += "\n";

  // Export features array
  code += `/**\n`;
  code += ` * Array of all discovered features with their metadata\n`;
  code += ` */\n`;
  code += `export const features = [\n`;

  featureNames.forEach((folderName) => {
    const camelName = kebabToCamel(folderName);
    const pascalName = kebabToPascal(folderName);
    const moduleName = `${camelName}Module`;
    const createFnName = `create${pascalName}`;

    code += `  { name: "${camelName}", create: ${moduleName}.${createFnName} },\n`;
  });

  code += `] as const;\n\n`;

  // Export type union
  code += `/**\n`;
  code += ` * Union type of all feature instances\n`;
  code += ` */\n`;
  code += `export type Feature = `;

  featureNames.forEach((folderName, index) => {
    const camelName = kebabToCamel(folderName);
    const pascalName = kebabToPascal(folderName);
    const moduleName = `${camelName}Module`;

    // Use ReturnType to infer the feature type from the create function
    code += `ReturnType<typeof ${moduleName}.create${pascalName}>`;
    if (index < featureNames.length - 1) {
      code += " | ";
    }
  });

  code += ";\n";

  return code;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Main Execution
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function main() {
  console.log("üîç Scanning for features...");

  const features = discoverFeatures();

  console.log(`‚úÖ Found ${features.length} feature(s):`);
  features.forEach((name) => console.log(`   - ${name}`));

  console.log("\nüìù Generating features/index.ts...");

  const code = generateFeaturesIndex(features);

  fs.writeFileSync(OUTPUT_FILE, code, "utf8");

  console.log(`‚úÖ Successfully generated: ${OUTPUT_FILE}`);
  console.log("");
}

// Run the script
try {
  main();
} catch (error) {
  console.error("‚ùå Error generating features index:", error);
  process.exit(1);
}
